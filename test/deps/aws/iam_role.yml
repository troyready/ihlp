---
AWSTemplateFormatVersion: '2010-09-09'
Description: IAM Role for integration teseting
Outputs:
  BoundaryPolicyArn:
    Description: Arn of IAM Managed Policy to be used as a permissions boundary
    Value:
      Ref: BoundaryPolicy
  RoleArn:
    Description: Arn of IAM Role
    Value:
      Fn::GetAtt:
        - Role
        - Arn
Parameters:
  EnvironmentName:
    Description: "Name of environment for the role (used in tags)"
    Type: String
  RepoName:
    Description: "Name of GitHub repo"
    Type: String
  ServiceName:
    Description: "Name of project"
    Type: String
Resources:
  BoundaryPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Role boundary policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":logs:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :log-group:/aws/lambda/inttest*
  PermissionsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Role permissions policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - iam:AttachRolePolicy
              - iam:CreateRole
              - iam:DetachRolePolicy
              - iam:PutRolePolicy
            Effect: Allow
            Condition:
              StringEquals:
                "iam:PermissionsBoundary":
                  Ref: BoundaryPolicy
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":iam::"
                  - Ref: AWS::AccountId
                  - :role/inttest*
          - Action:
              - iam:DeleteRole
              - iam:DeleteRolePolicy
              - iam:GetRole
              - iam:GetRolePolicy
              - iam:ListAttachedRolePolicies
              - iam:ListInstanceProfilesForRole
              - iam:ListRolePolicies
              - iam:ListRoleTags
              - iam:PassRole
              - iam:TagRole
              - iam:UntagRole
              - iam:UpdateRoleDescription
            Effect: Allow
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":iam::"
                  - Ref: AWS::AccountId
                  - :role/inttest*
          - Action:
              - cloudformation:CreateChangeSet
              - cloudformation:DeleteChangeSet
              - cloudformation:DeleteStack
              - cloudformation:DescribeChangeSet
              - cloudformation:DescribeStacks
              - cloudformation:ExecuteChangeSet
              - cloudformation:TagResource
              - cloudformation:UntagResource
            Effect: Allow
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":cloudformation:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :stack/inttest*
          - Action:
              - dynamodb:CreateTable
              - dynamodb:DeleteItem
              - dynamodb:DeleteTable
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:TagResource
              - dynamodb:UntagResource
              - dynamodb:UpdateTable
            Effect: Allow
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":dynamodb:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :table/inttest*
          - Action:
              - lambda:CreateFunction
              - lambda:DeleteFunction
              - lambda:GetFunction
              - lambda:GetFunctionCodeSigningConfig
              - lambda:InvokeFunction
              - lambda:ListTags
              - lambda:ListVersionsByFunction
              - lambda:TagResource
              - lambda:UntagResource
              - lambda:UpdateFunctionCode
            Effect: Allow
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":lambda:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :function:inttest*
          - Action:
              - s3:CreateBucket
              - s3:DeleteBucket
              - s3:DeleteObject
              - s3:DeleteObjectVersion
              - s3:GetBucketVersioning
              - s3:GetLifecycleConfiguration
              - s3:GetObject
              - s3:HeadObject
              - s3:ListBucket
              - s3:ListBucketVersions
              - s3:PutBucketVersioning
              - s3:PutLifecycleConfiguration
              - s3:PutObject
            Effect: Allow
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":s3:::"
                  - inttest*
          - Action:
              - ssm:DeleteParameter
              - ssm:GetParameter
              - ssm:PutParameter
            Effect: Allow
            Resource:
              - Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":ssm:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :parameter/inttest*
  Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:oidc-provider/vstoken.actions.githubusercontent.com
            Condition:
              StringLike:
                vstoken.actions.githubusercontent.com:sub: !Sub repo:${RepoName}:*
      ManagedPolicyArns:
        - Ref: PermissionsPolicy
      Tags:
        - Key: Environment
          Value:
            Ref: EnvironmentName
        - Key: Project
          Value:
            Ref: ServiceName
        - Key: Purpose
          Value: Integration Testing
